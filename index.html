<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像生成＆保存アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .message-box {
            padding: 1rem;
            background-color: #e2e8f0;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 0.875rem;
            color: #4b5563;
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s, transform 0.2s;
            cursor: pointer;
        }
        .button-primary:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }
        .button-disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-card {
            background-color: #e2e8f0;
            border-radius: 1rem;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            border: 4px solid transparent;
            transition: border-color 0.2s;
        }
        .image-card.selected {
            border-color: #4f46e5;
        }
        .image-card img {
            max-width: 100%;
            height: auto;
            border-radius: 1rem;
            display: block;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        .selection-info {
            font-weight: bold;
            text-align: center;
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800">画像生成＆保存</h1>
        <div class="message-box" id="messageBox">ここにメッセージが表示されます。</div>

        <div class="flex flex-col sm:flex-row items-center gap-4">
            <input type="text" id="promptInput" placeholder="生成したい画像の説明を入力..." class="flex-grow w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="generateBtn" class="button-primary font-bold text-lg w-full sm:w-auto flex items-center justify-center gap-2">
                生成
                <div id="loader" class="loader hidden"></div>
            </button>
            <button id="loadPromptBtn" class="button-primary font-bold text-lg w-full sm:w-auto">低いアングル</button>
            <button id="loadPromptBtn2" class="button-primary font-bold text-lg w-full sm:w-auto">アングルなし</button>
        </div>

        <!-- 上部の保存ボタン -->
        <button id="saveBtnTop" class="button-primary font-bold text-lg button-disabled" disabled>画像を保存</button>
        <p id="selectionInfoTop" class="selection-info">0 枚の画像を選択済み</p>
        
        <div id="outputContainer" class="image-grid">
            <!-- 生成された画像がここに追加されます -->
        </div>

        <!-- 下部の保存ボタン -->
        <button id="saveBtnBottom" class="button-primary font-bold text-lg button-disabled" disabled>画像を保存</button>
        <p id="selectionInfoBottom" class="selection-info">0 枚の画像を選択済み</p>

    </div>

    // 開発時のみ有効
const API_KEY = process.env.VITE_GEMINI_API_KEY;
const response = await fetch(`https://generativelanguage.googleapis.com/...`, {
  // ...
  headers: {
    'x-api-key': API_KEY, // AIzaSyC_CG-uZva94ZFbb5u4WDHlDWbbnvTLboc
  },
});

    <script>
        const promptInput = document.getElementById('promptInput');
        const generateBtn = document.getElementById('generateBtn');
        const saveBtnTop = document.getElementById('saveBtnTop');
        const saveBtnBottom = document.getElementById('saveBtnBottom');
        const outputContainer = document.getElementById('outputContainer');
        const messageBox = document.getElementById('messageBox');
        const loader = document.getElementById('loader');
        const selectionInfoTop = document.getElementById('selectionInfoTop');
        const selectionInfoBottom = document.getElementById('selectionInfoBottom');
        const loadPromptBtn = document.getElementById('loadPromptBtn');
        const loadPromptBtn2 = document.getElementById('loadPromptBtn2');

        const apiKey = "";
        
        let generatedBlobs = new Map();
        let selectedBlobs = new Map();

        const predefinedPrompt = `**全体的な構図と視点:**
画像は低いアングルから上方向を見上げるような視点、フレームの端に向かうにつれて画像が丸く歪んでおり、まるで覗き穴から見ているような、あるいは監視カメラの映像のような独特の雰囲気があります。フレームの周囲は暗く（ビネット効果）、中央の被写体に視線が集まるようになっています。`;

        const predefinedPrompt2 = `**全体的な構図と視点:**
フレームの端に向かうにつれて画像が丸く歪んでおり、まるで覗き穴から見ているような、あるいは監視カメラの映像のような独特の雰囲気があります。フレームの周囲は暗く（ビネット効果）、中央の被写体に視線が集まるようになっています。`;

        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.style.backgroundColor = isError ? '#fee2e2' : '#dbeafe';
            messageBox.style.color = isError ? '#991b1b' : '#1e40af';
        }

        function setButtonState(generating) {
            generateBtn.disabled = generating;
            generateBtn.classList.toggle('button-disabled', generating);
            loader.classList.toggle('hidden', !generating);
            generateBtn.textContent = generating ? '生成中...' : '生成';
            loadPromptBtn.disabled = generating;
            loadPromptBtn2.disabled = generating;
        }

        function updateSaveButtons() {
            const hasSelection = selectedBlobs.size > 0;
            const buttonClassList = [saveBtnTop.classList, saveBtnBottom.classList];
            const infoText = `${selectedBlobs.size} 枚の画像を選択済み`;

            saveBtnTop.disabled = !hasSelection;
            saveBtnBottom.disabled = !hasSelection;
            
            buttonClassList.forEach(list => list.toggle('button-disabled', !hasSelection));
            
            selectionInfoTop.textContent = infoText;
            selectionInfoBottom.textContent = infoText;
        }

        function createAndDisplayImageElement(base64Data, index) {
            return new Promise((resolve) => {
                const tempImage = new Image();
                tempImage.onload = () => {
                    const canvas = document.createElement('canvas');
                    const targetRatio = 3 / 4;
                    let cropWidth, cropHeight, cropX, cropY;

                    if (tempImage.width / tempImage.height > targetRatio) {
                        cropHeight = tempImage.height;
                        cropWidth = tempImage.height * targetRatio;
                        cropX = (tempImage.width - cropWidth) / 2;
                        cropY = 0;
                    } else {
                        cropWidth = tempImage.width;
                        cropHeight = tempImage.width / targetRatio;
                        cropX = 0;
                        cropY = (tempImage.height - cropHeight) / 2;
                    }

                    canvas.width = cropWidth;
                    canvas.height = cropHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(tempImage, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

                    canvas.toBlob(blob => {
                        const imageId = `image-${Date.now()}-${index}`;
                        generatedBlobs.set(imageId, blob);
                        
                        const imageCard = document.createElement('div');
                        imageCard.className = 'image-card';
                        imageCard.dataset.imageId = imageId;

                        const imageUrl = URL.createObjectURL(blob);
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = `Generated Image ${index + 1}`;
                        
                        imageCard.appendChild(img);
                        outputContainer.appendChild(imageCard);

                        imageCard.addEventListener('click', () => {
                            if (imageCard.classList.contains('selected')) {
                                imageCard.classList.remove('selected');
                                selectedBlobs.delete(imageId);
                            } else {
                                imageCard.classList.add('selected');
                                selectedBlobs.set(imageId, blob);
                            }
                            updateSaveButtons();
                        });
                        resolve();
                    }, 'image/jpeg', 0.9);
                };
                tempImage.src = `data:image/png;base64,${base64Data}`;
            });
        }
        
        async function generateImages(prompt, count) {
            setButtonState(true);
            outputContainer.innerHTML = '';
            generatedBlobs.clear();
            selectedBlobs.clear();
            updateSaveButtons();
            
            showMessage(`画像を${count}枚生成しています...`);

            for (let i = 0; i < count; i++) {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseModalities: ['TEXT', 'IMAGE'] },
                    };

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`APIエラー: ${response.status}`);
                    }
                    const result = await response.json();
                    
                    const candidate = result?.candidates?.[0];
                    if (candidate && candidate.content?.parts?.find(p => p.inlineData)) {
                        const base64Data = candidate.content.parts.find(p => p.inlineData).inlineData.data;
                        await createAndDisplayImageElement(base64Data, i);
                        showMessage(`${i + 1}/${count}枚の画像が生成されました。`);
                    } else if (candidate && candidate.finishReason === 'PROHIBITED_CONTENT') {
                        console.error('APIレスポンスに画像データがありませんでした:', result);
                        showMessage('プロンプトが不適切なコンテンツとして判断されました。別の表現を試してください。', true);
                        setButtonState(false);
                        return;
                    } else if (candidate && candidate.content?.parts?.[0]?.text) {
                        console.error('APIレスポンスに画像データがありませんでした:', result);
                        showMessage('APIが画像ではなくテキストを返しました。プロンプトを具体的に書き換えて再度試してください。', true);
                        setButtonState(false);
                        return;
                    } else {
                        console.error('APIレスポンスに画像データがありませんでした:', result);
                        showMessage('APIが予期しない形式の応答を返しました。プロンプトを変更して再度試してください。', true);
                        setButtonState(false);
                        return;
                    }
                } catch (error) {
                    console.error('画像生成エラー:', error);
                    showMessage(`エラーが発生しました。${i + 1}枚目以降の生成を中止します。`);
                    break;
                }
            }
            setButtonState(false);
            if (generatedBlobs.size === count) {
                showMessage('すべての画像の生成が完了しました。');
            }
        }

        generateBtn.addEventListener('click', () => {
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) {
                showMessage('プロンプトを入力してください。', true);
                return;
            }
            generateImages(userPrompt, 1);
        });
        
        function handleSaveClick() {
            if (selectedBlobs.size === 0) {
                showMessage('保存する画像を選択してください。', true);
                return;
            }
            
            selectedBlobs.forEach((blob, id) => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${id}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
            showMessage(`${selectedBlobs.size}枚の画像を保存しました。`);
        }

        loadPromptBtn.addEventListener('click', () => {
            promptInput.value = predefinedPrompt;
            showMessage('プロンプトが入力されました。「生成」ボタンを押してください。');
        });
        
        loadPromptBtn2.addEventListener('click', () => {
            promptInput.value = predefinedPrompt2;
            showMessage('プロンプトが入力されました。「生成」ボタンを押してください。');
        });

        saveBtnTop.addEventListener('click', handleSaveClick);
        saveBtnBottom.addEventListener('click', handleSaveClick);

        showMessage('プロンプトを入力して「生成」ボタンを押してください。');
    </script>
</body>
</html>
