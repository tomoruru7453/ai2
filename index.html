<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>実写画像生成アプリ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem; /* Tailwind 'gap-6' */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 md:p-8">
    <div class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl w-full max-w-2xl text-center">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2">実写画像ジェネレーター</h1>
        <p class="text-gray-600 mb-8">テキストプロンプトを入力すると、1枚のユニークな実写画像が自動的に生成されます。</p>

        <form id="image-form" class="space-y-6">
            <input type="text" id="prompt-input" placeholder="例：美しい夕日の下を歩く犬" class="w-full px-5 py-3 text-gray-800 placeholder-gray-400 border border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-transparent transition duration-300 ease-in-out" required>
            
            <button type="submit" id="generate-button" class="w-full px-6 py-3 font-semibold text-white bg-blue-600 rounded-xl shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed">
                画像を生成
            </button>
        </form>

        <div id="loading-spinner" class="mt-8 hidden">
            <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-e-transparent align-[-0.125em] text-blue-600" role="status">
                <span class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">読み込み中...</span>
            </div>
            <p class="text-gray-500 mt-2">画像を生成中...</p>
        </div>

        <div id="image-container" class="mt-8 image-grid">
            <!-- 生成された画像がここに表示されます -->
        </div>

        <button id="download-button" class="mt-6 w-full px-6 py-3 font-semibold text-white bg-green-600 rounded-xl shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition duration-300 ease-in-out hidden">
            選択した画像をダウンロード
        </button>

        <!-- カスタムモーダルメッセージボックス -->
        <div id="message-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-900 bg-opacity-50 p-4">
            <div class="bg-white rounded-xl p-8 max-w-sm text-center shadow-lg">
                <p id="modal-text" class="text-gray-800 font-semibold mb-4"></p>
                <button id="modal-close-button" class="px-6 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition">OK</button>
            </div>
        </div>
    </div>

    <script>
        // DOM要素の取得
        const form = document.getElementById('image-form');
        const promptInput = document.getElementById('prompt-input');
        const generateButton = document.getElementById('generate-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const imageContainer = document.getElementById('image-container');
        const downloadButton = document.getElementById('download-button');
        const messageModal = document.getElementById('message-modal');
        const modalText = document.getElementById('modal-text');
        const modalCloseButton = document.getElementById('modal-close-button');

        // プロンプトのバリエーションに使用する単語リスト
        const styles = ['超高精細', '写真写実的', '映画のような照明', 'ポートレート', 'デジタルアート', 'コンセプトアート', 'コミックアート', 'ピクセルアート', '水彩画', '油絵', 'インク画'];
        const cameras = ['一眼レフカメラで撮影', '手持ちカメラ', '広角レンズ', '望遠レンズ', 'ドローンからの眺め', 'マクロレンズ', 'シネマティックカメラ', 'ヴィンテージレンズ', 'パンショット', 'ティルトショット', 'ズームイン', 'ズームアウト', 'クレーンショット', 'ドリーショット', '手ブレ補正付き'];
        const lightings = ['自然光', '柔らかな照明', 'ゴールデンアワー', 'ドラマチックな影', 'スタジオ照明', '蛍光灯', 'ネオンサイン', '逆光', '夕暮れ時の光'];
        const locations = ['都市の風景', '自然の風景', '室内', '屋上', '宇宙空間', '水中', 'ジャングル', '廃墟', '古代の遺跡'];
        const perspectives = ['ローアングル', 'ハイアングル', '一人称視点', 'クローズアップショット', '全身ショット', '遠景', '鳥瞰図', 'アイレベルショット', 'ショルダーショット', 'ヒップショット', '地面からの視点', '空中からの視点'];

        // メッセージモーダルを表示する関数
        function showMessage(message) {
            modalText.textContent = message;
            messageModal.classList.remove('hidden');
            modalText.classList.remove('hidden');
            modalCloseButton.classList.remove('hidden');
            messageModal.classList.add('flex');
        }

        // メッセージモーダルを非表示にする関数
        function hideMessage() {
            modalText.textContent = "";
            messageModal.classList.add('hidden');
            messageModal.classList.remove('flex');
        }

        modalCloseButton.addEventListener('click', hideMessage);

        /**
         * 指数バックオフ付きのフェッチ関数
         * @param {string} url - API URL
         * @param {object} options - フェッチオプション
         * @param {number} retries - 残りの再試行回数
         * @param {number} delay - 次の再試行までの遅延時間（ミリ秒）
         */
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`APIエラー: ${response.statusText}. 詳細: ${JSON.stringify(errorData)}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    console.warn(`フェッチ失敗。再試行... 残り: ${retries}`);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }
        
        /**
         * 画像を特定の寸法にリサイズする関数
         * @param {string} base64Data - リサイズする画像のBase64データ
         * @param {number} targetWidth - ターゲットの幅
         * @param {number} targetHeight - ターゲットの高さ
         * @returns {Promise<string>} - リサイズされた画像のデータURL
         */
        function resizeImage(base64Data, targetWidth, targetHeight) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    const ctx = canvas.getContext('2d');
                    // 画像の元の縦横比を維持しながら描画
                    const originalAspect = img.width / img.height;
                    const targetAspect = targetWidth / targetHeight;
                    let drawWidth, drawHeight, offsetX, offsetY;
                    if (originalAspect > targetAspect) {
                        drawHeight = targetHeight;
                        drawWidth = img.width * (targetHeight / img.height);
                        offsetX = (targetWidth - drawWidth) / 2;
                        offsetY = 0;
                    } else {
                        drawWidth = targetWidth;
                        drawHeight = img.height * (targetWidth / img.width);
                        offsetX = 0;
                        offsetY = (targetHeight - drawHeight) / 2;
                    }
                    ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = `data:image/png;base64,${base64Data}`;
            });
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userPrompt = promptInput.value.trim();

            if (!userPrompt) {
                showMessage("プロンプトを入力してください。");
                return;
            }

            // UIの状態を更新
            generateButton.disabled = true;
            generateButton.textContent = "生成中...";
            loadingSpinner.classList.remove('hidden');
            imageContainer.innerHTML = '';
            downloadButton.classList.add('hidden'); // ダウンロードボタンを非表示にする

            try {
                const totalImages = 1;
                const generationPromises = [];

                // 1枚の画像を生成するためのPromiseを配列に追加
                for (let i = 0; i < totalImages; i++) {
                    const randomStyle = styles[Math.floor(Math.random() * styles.length)];
                    const randomCamera = cameras[Math.floor(Math.random() * cameras.length)];
                    const randomLighting = lightings[Math.floor(Math.random() * lightings.length)];
                    const randomLocation = locations[Math.floor(Math.random() * locations.length)];
                    const randomPerspective = perspectives[Math.floor(Math.random() * perspectives.length)];

                    const formattedPrompt = `${userPrompt}, ${randomStyle}, ${randomCamera}, ${randomLighting}, ${randomLocation}, ${randomPerspective}`;

                    const payload = {
                        instances: [{ prompt: formattedPrompt }],
                        parameters: {
                            "sampleCount": 1
                        }
                    };

                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                    // Promiseを配列に追加
                    generationPromises.push(
                        fetchWithRetry(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        .then(response => response.json())
                        .catch(error => {
                            console.error(`画像の生成に失敗しました（${i + 1}回目）:`, error);
                            return null; // 失敗した場合はnullを返す
                        })
                    );
                }

                // すべてのPromiseが完了するまで待機
                const results = await Promise.all(generationPromises);
                let successfulImages = 0;

                for (const result of results) {
                    if (result && result.predictions && result.predictions.length > 0) {
                        const prediction = result.predictions[0];
                        if (prediction.bytesBase64Encoded) {
                            // 画像のリサイズ
                            const resizedImageUrl = await resizeImage(prediction.bytesBase64Encoded, 270, 480);

                            const imageWrapper = document.createElement('div');
                            // 画像の選択を可能にするために'relative'クラスを追加し、クリックリスナーを追加
                            imageWrapper.className = "relative aspect-[9/16] overflow-hidden rounded-2xl shadow-xl border-4 border-transparent hover:border-blue-500 transition-all cursor-pointer";
                            
                            const imgElement = document.createElement('img');
                            imgElement.src = resizedImageUrl;
                            imgElement.alt = userPrompt;
                            imgElement.className = "w-full h-full object-cover";

                            // クリックイベントリスナーを追加して選択状態を切り替える
                            imageWrapper.addEventListener('click', () => {
                                // 選択状態をトグル
                                imageWrapper.classList.toggle('border-blue-500');
                                imageWrapper.classList.toggle('border-transparent');
                                imageWrapper.classList.toggle('selected');
                            });

                            imageWrapper.appendChild(imgElement);
                            imageContainer.appendChild(imageWrapper);
                            successfulImages++;
                        }
                    }
                }

                if (successfulImages === 0) {
                    showMessage("画像の生成に失敗しました。別のプロンプトを試してください。");
                } else {
                    downloadButton.classList.remove('hidden'); // 少なくとも1枚の画像が生成されたらボタンを表示
                }
            } catch (error) {
                console.error("全体的な生成エラー:", error);
                showMessage(`画像の生成中に予期せぬエラーが発生しました。\n詳細: ${error.message}`);
            } finally {
                // UIの状態をリセット
                generateButton.disabled = false;
                generateButton.textContent = "画像を生成";
                loadingSpinner.classList.add('hidden');
            }
        });

        // 選択した画像をダウンロードする機能
        downloadButton.addEventListener('click', () => {
            const selectedImages = document.querySelectorAll('#image-container .selected img');
            if (selectedImages.length === 0) {
                showMessage("保存する画像を1つ以上選択してください。");
                return;
            }

            selectedImages.forEach((imgElement, index) => {
                const link = document.createElement('a');
                link.href = imgElement.src;
                link.download = `generated_image_${index + 1}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            showMessage(`${selectedImages.length}枚の画像を保存しました。`);
        });
    </script>
</body>
</html>
