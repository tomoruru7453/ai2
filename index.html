<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI画像プロンプトジェネレーター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #2d3748;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .step-container {
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .option-button {
            transition: all 0.2s ease-in-out;
        }
        .option-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .option-button.selected {
            background-color: #4a5568;
            border-color: #4299e1;
            transform: scale(1.02);
        }
        #messageBox {
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }
        #messageBox.show {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="p-4">
    <div class="container text-center">
        <h1 class="text-3xl font-bold mb-4 text-white">AI画像 プロンプトジェネレーター</h1>
        <p class="text-gray-400 mb-6">ステップごとに要素を選んで、オリジナルプロンプトを作成しよう！</p>

        <!-- Current Step View -->
        <div id="step-view" class="step-container">
            <!-- Content will be dynamically added here by JavaScript -->
        </div>

        <!-- Prompt Display and Copy Section -->
        <div class="mt-8 pt-4 border-t border-gray-600">
            <h2 class="text-xl font-semibold mb-2 text-white">現在のプロンプト</h2>
            <div class="bg-gray-700 p-4 rounded-lg mb-4 text-gray-200 break-words" id="prompt-display"></div>
            <button id="copy-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                プロンプトをコピーして生成
            </button>
            <button id="refresh-button" class="mt-4 w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-gray-600 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-gray-800">
                人数以外を更新
            </button>
        </div>

        <!-- Message Box -->
        <div id="messageBox" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-green-600 text-white py-2 px-4 rounded-full shadow-xl">
            コピーしました！
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const BASE_PROMPT_PARTS = {
                clothing: 'wearing white sailor uniform blouses and short navy blue pleated skirts',
                style: 'a realistic smartphone photo style'
            };
            
            // Static step for person count
            const staticSteps = [
                {
                    title: '1. 人数を選んでみましょう',
                    options: [
                        { name: '1人', subject: 'a single person, a slender, large-breasted 20-year-old Japanese actress' },
                        { name: '2人', subject: 'two people, a pair of slender, large-breasted 20-year-old Japanese actresses' },
                        { name: '3人', subject: 'three people, a trio of slender, large-breasted 20-year-old Japanese actresses' },
                        { name: '複数人', subject: 'a group of people, several slender, large-breasted 20-year-old Japanese actresses' }
                    ]
                }
            ];

            let steps = [];
            let currentStepIndex = 0;
            let generatedPrompt = '';
            let selectedOptions = Array(staticSteps.length + 5).fill(null); // 5 is the number of dynamic steps

            const stepView = document.getElementById('step-view');
            const promptDisplay = document.getElementById('prompt-display');
            const copyButton = document.getElementById('copy-button');
            const refreshButton = document.getElementById('refresh-button');
            const messageBox = document.getElementById('messageBox');
            
            // API key is empty as it will be provided by the runtime
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            // Function to generate dynamic steps by using the Gemini API
            async function generateDynamicSteps() {
                // Display loading state
                stepView.innerHTML = '<div class="text-white text-lg animate-pulse">新しい要素を生成中...</div>';
                refreshButton.disabled = true;

                // AIに日本語の要素名と英語のプロンプト用フレーズを生成するよう指示する
                const userQuery = "Generate a JSON array with 4 completely original and creative options for each of the following categories: 'accessories', 'backgrounds', 'poses', 'angles', 'accents'. Each option must have a clear, concise Japanese 'name' and an English 'phrase' suitable for an AI image generation prompt. The subject is a 20-year-old Japanese actress in a sailor uniform. Ensure the phrases are descriptive and varied. Return only the JSON.";
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                accessories: {
                                    type: "ARRAY",
                                    items: { type: "OBJECT", properties: { name: { type: "STRING" }, phrase: { type: "STRING" } } }
                                },
                                backgrounds: {
                                    type: "ARRAY",
                                    items: { type: "OBJECT", properties: { name: { type: "STRING" }, phrase: { type: "STRING" } } }
                                },
                                poses: {
                                    type: "ARRAY",
                                    items: { type: "OBJECT", properties: { name: { type: "STRING" }, phrase: { type: "STRING" } } }
                                },
                                angles: {
                                    type: "ARRAY",
                                    items: { type: "OBJECT", properties: { name: { type: "STRING" }, phrase: { type: "STRING" } } }
                                },
                                accents: {
                                    type: "ARRAY",
                                    items: { type: "OBJECT", properties: { name: { type: "STRING" }, phrase: { type: "STRING" } } }
                                }
                            }
                        }
                    },
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonString) {
                        throw new Error('API response format is invalid.');
                    }
                    const dynamicOptions = JSON.parse(jsonString);

                    const dynamicSteps = [
                        { title: '2. 小物を選んでみましょう', options: dynamicOptions.accessories },
                        { title: '3. 背景を選んでみましょう', options: dynamicOptions.backgrounds },
                        { title: '4. ポーズを選んでみましょう', options: dynamicOptions.poses },
                        { title: '5. アングルを選んでみましょう', options: dynamicOptions.angles },
                        { title: '6. アクセントを追加してみましょう', options: dynamicOptions.accents },
                    ];
                    
                    refreshButton.disabled = false;
                    return dynamicSteps;
                } catch (error) {
                    console.error('Error generating dynamic steps:', error);
                    refreshButton.disabled = false;
                    // Fallback to a default set of options in case of an error
                    return [
                         { title: '2. 小物を選んでみましょう', options: [{name: '猫', phrase: 'gently holding a fluffy cat'},{name: '花束', phrase: 'carrying a vibrant bouquet of sunflowers'},{name: 'イヤホン', phrase: 'with white wired earbuds'},{name: 'カメラ', phrase: 'with a vintage film camera'}]},
                         { title: '3. 背景を選んでみましょう', options: [{name: '神社', phrase: 'in a quiet Japanese shrine garden'},{name: '駅のホーム', phrase: 'on a bustling train platform'},{name: '屋上', phrase: 'on a school rooftop at sunset'},{name: '森の中', phrase: 'in a dense, foggy forest'}]},
                         { title: '4. ポーズを選んでみましょう', options: [{name: '恥ずかしそうに下を向く', phrase: 'looking down shyly'},{name: 'ピースサイン', phrase: 'making a peace sign'},{name: '楽しそうに走る', phrase: 'running and laughing happily'},{name: '壁にもたれる', phrase: 'leaning against a brick wall'}]},
                         { title: '5. アングルを選んでみましょう', options: [{name: 'ローアングル', phrase: 'shot from a low-angle'},{name: 'ハイアングル', phrase: 'shot from a high-angle'},{name: 'ポートレート', phrase: 'a classic portrait shot'},{name: '後ろ姿', phrase: 'an over-the-shoulder perspective'}]},
                         { title: '6. アクセントを追加してみましょう', options: [{name: '玉ボケ', phrase: 'with beautiful bokeh'},{name: '雨に濡れた髪', phrase: 'with her hair slightly wet'},{name: '鮮やかな影', phrase: 'with sharp, dynamic shadows'},{name: '桜吹雪', phrase: 'with cherry blossom petals'}]},
                    ];
                }
            }

            // Function to initialize or reset the app
            async function initializeApp() {
                const dynamicSteps = await generateDynamicSteps();
                steps = staticSteps.concat(dynamicSteps);
                currentStepIndex = 0;
                generatedPrompt = '';
                selectedOptions = Array(steps.length).fill(null);
                renderStep();
            }

            // Function to refresh all steps except for the first one
            async function refreshOptionsExceptNumber() {
                const firstSelectedOption = selectedOptions[0];
                const dynamicSteps = await generateDynamicSteps();
                steps = staticSteps.concat(dynamicSteps);
                selectedOptions = Array(steps.length).fill(null);
                selectedOptions[0] = firstSelectedOption;
                currentStepIndex = 1; // Reset to the second step
                updatePrompt();
                renderStep();
            }

            // Function to render the current step
            function renderStep() {
                const step = steps[currentStepIndex];
                if (!step) {
                    // This handles the case where we've reached the end
                    stepView.innerHTML = `
                        <h2 class="text-2xl font-semibold text-green-400">完成！</h2>
                        <p class="text-gray-300 mt-2">下のボタンでプロンプトをコピーできます。</p>
                        <button id="start-over" class="mt-6 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-600 transition duration-200 focus:outline-none">最初からやり直す</button>
                    `;
                    document.getElementById('start-over').addEventListener('click', () => {
                        initializeApp();
                    });
                    updatePromptDisplay();
                    return;
                }
                
                let html = `
                    <h2 class="text-xl font-semibold mb-4 text-white">${step.title}</h2>
                    <div class="grid grid-cols-2 gap-4 w-full px-4 sm:px-0 sm:w-2/3">
                `;
                step.options.forEach((option, index) => {
                    const isSelected = selectedOptions[currentStepIndex] === index;
                    const selectedClass = isSelected ? 'selected' : '';
                    html += `
                        <button class="option-button bg-gray-600 text-gray-200 py-3 px-4 rounded-lg shadow-md hover:bg-gray-700 transition duration-200 ${selectedClass}"
                                data-index="${index}">${option.name}</button>
                    `;
                });
                html += `</div>`;
                
                // Add navigation buttons
                html += `<div class="mt-6 flex justify-between w-full px-4 sm:px-0 sm:w-2/3">`;
                if (currentStepIndex > 0) {
                    html += `<button id="prev-button" class="w-1/3 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-600 transition duration-200 focus:outline-none">戻る</button>`;
                } else {
                    html += `<div class="w-1/3"></div>`;
                }
                html += `<button id="next-button" class="w-1/3 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-200 focus:outline-none">次へ</button>`;
                html += `</div>`;

                stepView.innerHTML = html;
                updatePromptDisplay();
                attachEventListeners();
            }

            // Function to handle event listeners
            function attachEventListeners() {
                // Option buttons
                stepView.querySelectorAll('.option-button').forEach(button => {
                    button.addEventListener('click', () => {
                        const optionIndex = parseInt(button.dataset.index);
                        selectedOptions[currentStepIndex] = optionIndex;
                        updatePrompt();
                        renderStep(); // Re-render to show selection
                    });
                });

                // Next button
                const nextButton = document.getElementById('next-button');
                if (nextButton) {
                    nextButton.addEventListener('click', () => {
                        if (selectedOptions[currentStepIndex] !== null) {
                            currentStepIndex++;
                            if (currentStepIndex < steps.length) {
                                renderStep();
                            } else {
                                // Final step completed
                                renderStep();
                            }
                        }
                    });
                }
                
                // Previous button
                const prevButton = document.getElementById('prev-button');
                if (prevButton) {
                    prevButton.addEventListener('click', () => {
                        currentStepIndex--;
                        renderStep();
                    });
                }
            }

            // Function to update the prompt string
            function updatePrompt() {
                const selectedNumber = selectedOptions[0] !== null ? steps[0].options[selectedOptions[0]].subject : 'A realistic smartphone photo of a person';
                const accessory = selectedOptions[1] !== null ? steps[1].options[selectedOptions[1]].phrase : '';
                const background = selectedOptions[2] !== null ? steps[2].options[selectedOptions[2]].phrase : '';
                const pose = selectedOptions[3] !== null ? steps[3].options[selectedOptions[3]].phrase : '';
                const angle = selectedOptions[4] !== null ? steps[4].options[selectedOptions[4]].phrase : '';
                const accent = selectedOptions[5] !== null ? steps[5].options[selectedOptions[5]].phrase : '';

                // Build the final prompt string
                let parts = [selectedNumber, BASE_PROMPT_PARTS.clothing, accessory, pose, background, angle, accent, BASE_PROMPT_PARTS.style];
                
                generatedPrompt = parts.filter(Boolean).join('. ').replace(/\s\s+/g, ' ') + '.';

                updatePromptDisplay();
            }

            // Function to update the prompt display
            function updatePromptDisplay() {
                promptDisplay.textContent = generatedPrompt;
            }

            // Copy button logic
            copyButton.addEventListener('click', () => {
                const textarea = document.createElement('textarea');
                textarea.value = generatedPrompt.trim();
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessageBox();
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
                document.body.removeChild(textarea);
            });

            // Refresh button logic
            refreshButton.addEventListener('click', () => {
                refreshOptionsExceptNumber();
            });

            // Show and hide the message box
            function showMessageBox() {
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 2000);
            }

            // Initial render
            initializeApp();
        });
    </script>
</body>
</html>
